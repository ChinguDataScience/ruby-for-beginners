<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Ruby for Beginners">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="BEd2YAbpSQrRqU2-5wUifTTzvqTMGLLE269b0JZTfCs" />

    <title>Bonus: Sessions | Ruby for Beginners</title>

    <link href="../assets/stylesheets/monstas-8ef2dc26.css" rel="stylesheet" type="text/css" />
  </head>

  <body>
    <nav class="page-nav"><a class="prev" href="/bonus_2/storing_data.html">
  Previous
</a></nav>
    <nav class="page-nav"><a class="next" href="/bonus_2/validations.html">
  Next
</a></nav>

    <div>
      <nav class="toc">
        <h1>Contents</h1>
        <ul>
  <li>
    <a href="/index.html">
      Ruby For Beginners
    </a>
  </li>
  <li>
    <a href="/preface.html">
      Preface
    </a>
  </li>
  <li>
    <a href="/creation.html">
      Programming is creation
    </a>
  </li>
  <li class="directory">
    <a href="/learning_to_program.html">
      Learning to program
    </a>
    <ul>
      <li>
        <a href="/learning_to_program/learning_modes.html">
          Learning modes
        </a>
      </li>
      <li>
        <a href="/learning_to_program/dont_believe.html">
          Don&rsquo;t believe everything we say
        </a>
      </li>
      <li>
        <a href="/learning_to_program/formatting_code.html">
          Formatting your code
        </a>
      </li>
      <li>
        <a href="/learning_to_program/error_messages.html">
          Reading error messages
        </a>
      </li>
      <li>
        <a href="/learning_to_program/using_google.html">
          Using Google
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/your_tools.html">
      Your tools
    </a>
    <ul>
      <li>
        <a href="/your_tools/text_editor.html">
          Text Editor
        </a>
      </li>
      <li>
        <a href="/your_tools/terminal.html">
          Terminal
        </a>
      </li>
      <li>
        <a href="/your_tools/ruby_runtime.html">
          Ruby runtime
        </a>
      </li>
      <li>
        <a href="/your_tools/workflow.html">
          Programming workflow
        </a>
      </li>
      <li>
        <a href="/your_tools/irb.html">
          Interactive Ruby
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/object_oriented_programming.html">
      Object-oriented programming
    </a>
  </li>
  <li class="directory">
    <a href="/built_in_classes.html">
      Built-in classes
    </a>
    <ul>
      <li>
        <a href="/built_in_classes/numbers.html">
          Numbers
        </a>
      </li>
      <li>
        <a href="/built_in_classes/strings.html">
          Strings
        </a>
      </li>
      <li>
        <a href="/built_in_classes/symbols.html">
          Symbols
        </a>
      </li>
      <li>
        <a href="/built_in_classes/arrays.html">
          Arrays
        </a>
      </li>
      <li>
        <a href="/built_in_classes/hashes.html">
          Hashes
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/variables.html">
      Variables
    </a>
  </li>
  <li class="directory">
    <a href="/methods.html">
      Methods
    </a>
    <ul>
      <li>
        <a href="/methods/return_values.html">
          Return values
        </a>
      </li>
      <li>
        <a href="/methods/parentheses.html">
          Parentheses
        </a>
      </li>
      <li>
        <a href="/methods/writing_methods.html">
          Writing a new method
        </a>
      </li>
      <li>
        <a href="/methods/control_flow.html">
          Flow of execution
        </a>
      </li>
      <li>
        <a href="/methods/scopes.html">
          Scopes
        </a>
      </li>
      <li>
        <a href="/methods/printing.html">
          Printing things
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/everything_an_object.html">
      Everything is an object
    </a>
    <ul>
      <li>
        <a href="/everything_an_object/object_classes.html">
          Objects have classes
        </a>
      </li>
      <li>
        <a href="/everything_an_object/object_methods.html">
          Calling methods
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/string_interpolation.html">
      String interpolation
    </a>
  </li>
  <li>
    <a href="/nothing_and_truth.html">
      Nothingness and the truth
    </a>
  </li>
  <li class="directory">
    <a href="/blocks.html">
      Blocks
    </a>
    <ul>
      <li>
        <a href="/blocks/block_syntax.html">
          Alternative block syntaxes
        </a>
      </li>
      <li>
        <a href="/blocks/block_arguments.html">
          Block arguments
        </a>
      </li>
      <li>
        <a href="/blocks/block_return_values.html">
          Block return values
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/bonus_1.html">
      Bonus: Methods &amp; Operators
    </a>
    <ul>
      <li>
        <a href="/bonus_1/operator_methods.html">
          Operators are methods
        </a>
      </li>
      <li>
        <a href="/bonus_1/predicate_methods.html">
          Predicate methods
        </a>
      </li>
      <li>
        <a href="/bonus_1/other_methods.html">
          Lots of other methods
        </a>
      </li>
      <li>
        <a href="/bonus_1/questions_commands.html">
          Questions and commands
        </a>
      </li>
      <li>
        <a href="/bonus_1/conditionals.html">
          Conditionals
        </a>
      </li>
      <li>
        <a href="/bonus_1/operators.html">
          Operators
        </a>
      </li>
      <li>
        <a href="/bonus_1/arithmetical_operators.html">
          Arithmetical operators
        </a>
      </li>
      <li>
        <a href="/bonus_1/logical_operators.html">
          Logical operators
        </a>
      </li>
      <li>
        <a href="/bonus_1/comparison_operators.html">
          Comparison operators
        </a>
      </li>
      <li>
        <a href="/bonus_1/alternative-syntax.html">
          Alternative Syntax
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/writing_classes.html">
      Writing classes
    </a>
    <ul>
      <li>
        <a href="/writing_classes/initializing_objects.html">
          Initializing objects
        </a>
      </li>
      <li>
        <a href="/writing_classes/instance_variables.html">
          Instance variables
        </a>
      </li>
      <li>
        <a href="/writing_classes/attribute_readers.html">
          Attribute readers
        </a>
      </li>
      <li>
        <a href="/writing_classes/attribute_writers.html">
          Attribute writers
        </a>
      </li>
      <li>
        <a href="/writing_classes/state_and_behaviour.html">
          State and behaviour
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/good_names.html">
      Using the right words
    </a>
  </li>
  <li class="directory expanded">
    <a href="/bonus_2.html">
      Bonus: Advanced Topics
    </a>
    <ul>
      <li>
        <a href="/bonus_2/libraries.html">
          Bonus: Using Libraries (1)
        </a>
      </li>
      <li>
        <a href="/bonus_2/modules.html">
          Bonus: Modules
        </a>
      </li>
      <li>
        <a href="/bonus_2/private_methods.html">
          Bonus: Private methods
        </a>
      </li>
      <li>
        <a href="/bonus_2/libraries_2.html">
          Bonus: Using Libraries (2)
        </a>
      </li>
      <li>
        <a href="/bonus_2/html.html">
          Bonus: HTML
        </a>
      </li>
      <li>
        <a href="/bonus_2/erb.html">
          Bonus: Embedded Ruby
        </a>
      </li>
      <li>
        <a href="/bonus_2/http.html">
          Bonus: HTTP
        </a>
      </li>
      <li>
        <a href="/bonus_2/rack.html">
          Bonus: Rack
        </a>
      </li>
      <li>
        <a href="/bonus_2/sinatra.html">
          Bonus: Sinatra
        </a>
      </li>
      <li>
        <a href="/bonus_2/forms.html">
          Bonus: Forms
        </a>
      </li>
      <li>
        <a href="/bonus_2/storing_data.html">
          Bonus: Storing data
        </a>
      </li>
      <li class="active">
        <a href="/bonus_2/sessions.html">
          Bonus: Sessions
        </a>
      </li>
      <li>
        <a href="/bonus_2/validations.html">
          Bonus: Validations
        </a>
      </li>
      <li>
        <a href="/bonus_2/resources.html">
          Bonus: Resources
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/exercises.html">
      Exercises
    </a>
    <ul>
      <li>
        <a href="/exercises/numbers.html">
          Working with Numbers
        </a>
      </li>
      <li>
        <a href="/exercises/strings.html">
          Working with Strings
        </a>
      </li>
      <li>
        <a href="/exercises/arrays_1.html">
          Working with Arrays (1)
        </a>
      </li>
      <li>
        <a href="/exercises/hashes_1.html">
          Working with Hashes (1)
        </a>
      </li>
      <li>
        <a href="/exercises/methods_1.html">
          Defining methods
        </a>
      </li>
      <li>
        <a href="/exercises/arrays_2.html">
          Working with Arrays (2)
        </a>
      </li>
      <li>
        <a href="/exercises/nested_arrays.html">
          Working with Nested Arrays
        </a>
      </li>
      <li>
        <a href="/exercises/hashes_2.html">
          Working with Hashes (2)
        </a>
      </li>
      <li>
        <a href="/exercises/truthiness.html">
          Truthiness
        </a>
      </li>
      <li>
        <a href="/exercises/email.html">
          The Email Class
        </a>
      </li>
      <li>
        <a href="/exercises/mailbox.html">
          The Mailbox Class
        </a>
      </li>
      <li>
        <a href="/exercises/mailbox_text.html">
          The Mailbox Text Formatter
        </a>
      </li>
      <li>
        <a href="/exercises/mailbox_html.html">
          The Mailbox Html Formatter
        </a>
      </li>
      <li>
        <a href="/exercises/mailbox_file.html">
          Storing our HTML to a File
        </a>
      </li>
      <li>
        <a href="/exercises/mailbox_csv.html">
          Reading from a CSV File
        </a>
      </li>
      <li>
        <a href="/exercises/mailbox_erb.html">
          Generating HTML using ERB
        </a>
      </li>
      <li>
        <a href="/exercises/mailbox_sinatra.html">
          Serving HTML using Sinatra
        </a>
      </li>
      <li>
        <a href="/exercises/rubygems.html">
          Using Rubygems
        </a>
      </li>
      <li>
        <a href="/exercises/bundler.html">
          Using Bundler
        </a>
      </li>
    </ul>
  </li>
</ul>
      </nav>
      <article>
        <nav class="menu"><a href="#"></a></nav>
        <h1>Bonus: Sessions</h1>

<p>HTTP is a so called <a href="http://en.wikipedia.org/wiki/Stateless_protocol">stateless protocol</a>.
Wikipedia says:</p>

<p><em>&ldquo;In computing, a stateless protocol is a communications protocol that treats
each request as an independent transaction that is unrelated to any previous
request so that the communication consists of independent pairs of request and
response.&rdquo;</em></p>

<p>Imagine talking to a person with a very shortlived memory:</p>

<p>&ldquo;Hey, who are you?&rdquo; - <em>&ldquo;I&rsquo;m a web application.&rdquo;</em>
&ldquo;Hey, who are you?&rdquo; - <em>&ldquo;I&rsquo;m a web application.&rdquo;</em>
&ldquo;Hey, who are you?&rdquo; - <em>&ldquo;I&rsquo;m a web application.&rdquo;</em>
&ldquo;How often have I just asked you who you are?&rdquo; - <em>&ldquo;I don&rsquo;t know, I don&rsquo;t keep track.&rdquo;</em></p>

<p>That&rsquo;s what&rsquo;s meant by HTTP being stateless: The web application just responds
to the request at hand, but has no way to identify how these requests relate to
each other.</p>

<p>Imagine thousands of users clicking around and using your web application. The
application would just respond to each of these requests individually, but does
not know from the protocol where these requests are coming from, or how many
people (browsers) it is talking to: There is no concept of a conversation, or
&ldquo;session&rdquo; in HTTP.</p>

<p>Basically.</p>

<p>However, of course there are ways to identify your users. We all know that we
can sign in to a web application, and it would recognize who we are. Right?
Often web applications use cookies for this.</p>

<p>A cookie is a little piece of information that a web application can send along
with a response, and that will be stored by the browser. From then on, when the
browser makes another request to the same application it will include the cookie
to the request, sending it back to the application.</p>

<p>For example, an HTTP response that sets a cookie for a user&rsquo;s prefered visual
theme could look like this:</p>
<pre class="highlight plaintext"><code>HTTP/1.0 200 OK
Content-type: text/html
Set-Cookie: theme=light
</code></pre>

<p>From now on, the browser would then include the cookie to subsequent requests:</p>
<pre class="highlight plaintext"><code>GET /blog.html HTTP/1.1
Host: rubymonstas.org
Cookie: theme=light
</code></pre>

<p>This way the application could apply the &ldquo;light&rdquo; theme to the blog, because the
user has selected it in some previous request: Cookies are a way to persist
(keep) state (data) across multiple requests.</p>

<p>Building on top of this, even though HTTP itself does not have a concept of a
&ldquo;session&rdquo; (or conversation), Sinatra (just as basically any web application
tool or framework) supports sessions. A session is a way for a web application
to set a cookie that persists arbitrary data across multiple requests.</p>

<p>Let&rsquo;s have a look how this works.</p>

<p>Say we&rsquo;d like to pass a message from our <code>post</code> route to the next request, saying
&ldquo;Successfully stored the name [name]&rdquo;. After successfully storing the name to
the file, we&rsquo;d like to pass a message to the <code>GET</code> request that the browser is
going to be redirected to.</p>

<p>We&rsquo;d only want to display this message once right after the redirection from
the <code>post</code> route: when we&rsquo;d reload the page it should be gone. This is called
transient state, and a session is a great place to keep it.</p>

<p>First, we need to enable the <code>:sessions</code> feature in Sinatra. You can do that
by adding this line above of your routes:</p>
<pre class="highlight ruby"><code><span class="n">enable</span> <span class="ss">:sessions</span>
</code></pre>

<p>Now, we want to store the message in our <code>post</code> route:</p>
<pre class="highlight ruby"><code><span class="n">post</span> <span class="s2">"/hello"</span> <span class="k">do</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span>
  <span class="n">store_name</span><span class="p">(</span><span class="s2">"names.txt"</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:message</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Successfully stored the name </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">."</span>
  <span class="n">redirect</span> <span class="s2">"/hello"</span>
<span class="k">end</span>
</code></pre>

<p>Ok, cool.</p>

<p>This will add a <code>Set-Cookie</code> header to the reponse which has a long, messy looking, encrypted
string as a value.</p>

<p>In my browser it looks like this:</p>
<pre class="highlight plaintext"><code>Set-Cookie: rack.session=BAh7CUkiD3Nlc3Npb25faWQGOgZFVEkiRWI4OTdhMDJlNDBkMDFlNjcxNWUw%0AZGI1ZWU5MzQ0YTQyMjAzYjFiZTE2YzYxNzgwMWQxYjI3NzhiOWNhYTQ4YzUG%0AOwBGSSIJY3NyZgY7AEZJIiU2ZjdjN2Y0ZmM0MTdmMGJkNjBkNmY5MmQ1NDEx%0ANGQ4ZgY7AEZJIg10cmFja2luZwY7AEZ7B0kiFEhUVFBfVVNFUl9BR0VOVAY7%0AAFRJIi03NGNlNDIxYTczNjMwZDY3MWViNTlkYzIzN2YyN2M5NGU3ZWU4NTRm%0ABjsARkkiGUhUVFBfQUNDRVBUX0xBTkdVQUdFBjsAVEkiLTA3NjBhNDRjMzU0%0AODIxMzJjZjIyNDQyYTBkODhjMDhiYjg1NTYyNTAGOwBGSSIIZm9vBjsARkki%0ACGJhcgY7AFQ%3D%0A; path=/; HttpOnly
</code></pre>

<p>Wow. Ok, the name of the cookie gives us a hint that this is a session, and it
is managed by Rack, which is what Sinatra uses under the hood to persist the
session.</p>

<p>Luckily we do not need to understand how exactly it does this. All we need to
know is that we can now use this data in the next request (the <code>GET</code> request)
like so:</p>
<pre class="highlight ruby"><code><span class="n">get</span> <span class="s2">"/hello"</span> <span class="k">do</span>
  <span class="vi">@message</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:message</span><span class="p">)</span>
  <span class="vi">@names</span> <span class="o">=</span> <span class="n">read_names</span>
  <span class="vi">@name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span>
  <span class="n">erb</span> <span class="ss">:hello</span>
<span class="k">end</span>
</code></pre>

<p>I.e. we delete the key <code>:message</code> from our session (which is something very
similar to a Ruby hash).  Deleting it will return the value that was stored on
this key, and we assign it to the instance variable <code>@message</code>, which makes it
available to our template.</p>

<p>That means we can now use the message in our view like so:</p>
<pre class="highlight erb"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@message</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@message</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>

<p>Let&rsquo;s try it out. Restart your application, and go to <a href="http://localhost:4567"><a href="http://localhost:4567">http://localhost:4567</a></a>.
If you enter a name, and click submit you should then see something like this:</p>

<p><img src="/assets/images/sessions_1-de7ddcac.png"></p>

<p>When you reload the page the message should be gone.</p>

<p>How does this work?</p>

<p>In our <code>post</code> route we store the message to the session hash. This has is
something that Sinatra provides to us as developers. When we enable this
feature then Sinatra will, after every request, store this hash to a cookie
with the name <code>rack.session</code>, in the encrypted form that you saw above.</p>

<p>We say the hash is being <a href="http://en.wikipedia.org/wiki/Serialization">serialized</a>,
which is a fancy way of saying that it is turned into some kind of format that
can be stored in text form. Sinatra (actually, Rack, under the hood) then also
encrypts and signs this data, so it is safe to send it over the internet (in
case we keep any sensitive data in it).</p>

<p>Ok, so the <code>post</code> route includes the <code>Set-Cookie</code> header with this session
cookie into its response, and sends it to the browser. The browser will, from
now on, pass this cookie back the our application as part of every subsequent
request.</p>

<p>When our browser is now redirected to <code>GET</code> the same URL again, it passes the
cookie, and Sinatra will, because we have the <code>:sessions</code> feature enabled,
<em>deserialize</em> (i.e. decrypt and read) the session data, and put it into the
hash that is returned by the method <code>session</code>, so we can work with it.</p>

<p>In our <code>get</code> route we now simply always delete the key <code>:message</code> from the
session hash. Should anything be in there it will be assigned to the <code>@message</code>
instance variable, and the view will display it. If nothing&rsquo;s stored on the
session key, for example when we reload the page, then deleting the key will
simply return nil, and nothing will be displayed in the view.</p>

<p>Does that make sense?</p>

<p>Awesome :)</p>

        <nav class="page-nav"><a class="prev" href="/bonus_2/storing_data.html">
  Previous
</a></nav>
        <nav class="page-nav"><a class="next" href="/bonus_2/validations.html">
  Next
</a></nav>
      </article>
    </div>

    <footer>
      <ul>
        <li><a href="http://rubymonstas.org">Ruby Monstas</a></li>
        <li><a href="mailto:ruby.monsters@gmail.com">Email</a></li>
        <li><a href="https://twitter.com/rubymonsters">Twitter</a></li>
        <li><a href="https://github.com/rubymonsters">GitHub</a></li>
        <li><a href="https://creativecommons.org/licenses/by-sa/2.0/" rel="license cc:license">License</a></li>
        <li><a href="http://foundation.travis-ci.org/imprint/">Imprint</a></li>
      </ul>
    </footer>

    <script src="../assets/javascripts/modernizr-4c875d94.js" type="text/javascript"></script>
    <script src="../assets/javascripts/monstas-e84d6217.js" type="text/javascript"></script>
  </body>
</html>
